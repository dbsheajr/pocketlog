# /etc/rsyslog.d/50-default.conf
# JSON lines to per-host/per-app files with fallback when programname is empty

# 1) JSONL template (one event per line)
template(name="jsonline" type="list") {
  constant(value="{")
    constant(value="\"time\":\"")     property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"host\":\"")  property(name="hostname")
    constant(value="\",\"app\":\"")   property(name="programname")
    constant(value="\",\"pri\":\"")   property(name="pri")
    constant(value="\",\"msg\":")     property(name="msg" format="json")
  constant(value="}\n")
}

# 2) DynaFile path templates â€” use sender IP instead of message hostname
template(name="plPathUnknown" type="string"
         string="/var/log/pocketlog/%fromhost-ip%/unknown.log")

template(name="plPathProg" type="string"
         string="/var/log/pocketlog/%fromhost-ip%/%programname%.log")

# Drop only true local logs; allow loopback if it came via UDP/TCP inputs
if ($inputname == "imuxsock" or $inputname == "imklog" or
    (($fromhost-ip == "127.0.0.1" or $fromhost-ip == "::1") and
     $inputname != "imudp" and $inputname != "imtcp")) then stop
