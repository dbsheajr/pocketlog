# /etc/rsyslog.d/01-remote-hourly.conf
# One combined file per hour, using kv_line_* templates.
# Files live in /var/log/pocketlog/YYYY-MM-DD-HH.log

module(load="mmjsonparse")  # safe to load multiple times; rsyslog dedups

# Path: /var/log/pocketlog/2025-10-27-16.log
template(name="HourlyCombinedPath" type="string"
         string="/var/log/pocketlog/%$year%-%$month%-%$day%-%$hour%.log")

# If body is JSON, capture it verbatim into msg='...'
template(name="kv_line_json" type="string"
         string="_time=%timegenerated:::date-rfc3339% host=%fromhost-ip% msg='%$!all-json%'\n")

# Otherwise, write trimmed raw message into msg='...'
template(name="kv_line_raw" type="string"
         string="_time=%timegenerated:::date-rfc3339% host=%fromhost-ip% msg='%msg:2:$:drop-last-lf%'\n")

# Ruleset for network inputs
ruleset(name="remote_raw") {
  # Try to parse message body as JSON (no cookie/prefix expected)
  action(type="mmjsonparse" cookie="")

  if ($parsesuccess == "OK") then {
    action(type="omfile"
           dynaFile="HourlyCombinedPath"
           template="kv_line_json"
           createDirs="on"
           dirCreateMode="0755"
           FileCreateMode="0644")
  } else {
    action(type="omfile"
           dynaFile="HourlyCombinedPath"
           template="kv_line_raw"
           createDirs="on"
           dirCreateMode="0755"
           FileCreateMode="0644")
  }
}
