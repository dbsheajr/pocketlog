# /etc/rsyslog.d/01-remote-hourly.conf
# One combined file per hour in /var/log/pocketlog/YYYY-MM-DD-HH.log
# No external parsing modules required.

template(name="HourlyCombinedPath" type="string"
         string="/var/log/pocketlog/%$year%-%$month%-%$day%-%$hour%.log")

# Trimmed raw message into msg='...'
template(name="kv_line_raw" type="string"
         string="_time=%timegenerated:::date-rfc3339% host=%fromhost-ip% msg='%msg:2:$:drop-last-lf%'\n")

# Ruleset: if the payload *looks* like JSON (starts with '{'), still write it as raw.
# (This keeps JSON bodies intact inside msg='...'; weâ€™re not parsing them.)
ruleset(name="remote_raw") {
  if re_match($msg, "^[[:space:]]*\\{") then {
    action(type="omfile"
           dynaFile="HourlyCombinedPath"
           template="kv_line_raw"
           createDirs="on" dirCreateMode="0755" FileCreateMode="0644")
  } else {
    action(type="omfile"
           dynaFile="HourlyCombinedPath"
           template="kv_line_raw"
           createDirs="on" dirCreateMode="0755" FileCreateMode="0644")
  }
}
