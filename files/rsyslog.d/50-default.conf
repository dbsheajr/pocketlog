# /etc/rsyslog.d/50-default.conf
# JSON lines to per-host/per-app files with fallback app name

# 1) JSONL template (one event per line)
template(name="jsonline" type="list") {
  constant(value="{")
    constant(value="\"time\":\"")     property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"host\":\"")  property(name="hostname")
    constant(value="\",\"app\":\"")   property(name="programname")
    constant(value="\",\"pri\":\"")   property(name="pri")
    constant(value="\",\"msg\":")     property(name="msg" format="json")
  constant(value="}\n")
}

# 2) Build a fallback app name in $!pl!app
set $!pl!app = $programname;
if ($!pl!app == "") then set $!pl!app = "unknown";

# 3) Dynamic file path using the fallback name
template(name="plDynFile" type="list") {
  constant(value="/var/log/pocketlog/")
  property(name="hostname")
  constant(value="/")
  property(name="$!pl!app")
  constant(value=".log")
}

# 4) Write to disk; create directories as needed
action(
  type="omfile"
  DynaFile="plDynFile"
  template="jsonline"
  createDirs="on"
  dirCreateMode="0755"
  FileCreateMode="0644"
)
